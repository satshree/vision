<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title> Vision </title>
    <link rel="stylesheet" href="./css/style.css">
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <!-- <link type="text/css" rel="stylesheet" href="materialize/css/materialize.css"  media="screen,projection"/> -->
    <link type="text/css" rel="stylesheet" href="./materialize/css/materialize.min.css"  media="screen,projection"/>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script>window.$ = window.jQuery = require('./js/jquery.js');</script>
    <style>
      .info-box {
        padding:0 150px;
      }
    </style>
  </head>

  <body>
      <div class="container">
        <div class="title center">
          <h1>Vision</h1>
          <strong> Seek and You Shall Receive </strong>
        </div>
        <hr>
        <div class="contents center">
          <a href="./templates/default.html"> <button class="waves-effect waves-light btn home-btn tooltipped" data-tooltip="Vision will scan everything for you."> Let Vision Do The Dirty Work. </button> </a>
          <a href="./templates/custom.html"> <button class="waves-effect waves-light btn home-btn tooltipped" data-tooltip="Tell Vision how to scan the network."> Scan The Network Yourself. </button> </a>
          <!-- <a href="./templates/live.html"> <button class="waves-effect waves-light btn home-btn tooltipped" data-tooltip="Monitor live HTTP/HTTPS Requests."> Monitor Your Internet Traffic. </button> </a> -->
        </div>
        <div style="padding:0 100px;" class="center">
          <strong> Your IP Address: </strong><i id="ip"> ... </i> <br>
          <strong> Your Gateway Address: </strong><i id="gateway"> ... </i>
        </div>
        <br> <br>
        <div class="container info-box">
          <hr>
          <p align="center">
            Vision scans your network for online devices.
            <br>
            <!-- <small>
              Vision was started back in June of 2019 â€“ developed by Satshree Shrestha.
            </small> -->
          </p>
        </div>
      </div>

    <!--JavaScript at end of body for optimized loading-->
    <!-- <script type="text/javascript" src="materialize/js/materialize.js"></script> -->
    <script type="text/javascript" src="./materialize/js/materialize.min.js"></script>
  </body>
  <script>
    $(document).ready(function(){
      $('.tooltipped').tooltip();
    });
    let swal = require("sweetalert")
    const child_process = require('child_process')
    const remote = require('electron').remote
    const pyshell = child_process.spawn("python", [".\\engine\\boot.py"]);

    pyshell.on('error', (err) => {
      // console.log(err)
      swal({
        title:"Seems like you have not installed Python!",
        text:"Please install Python to proceed.",
        icon:"warning"
      }).then(() => {
        const w = remote.getCurrentWindow()
        w.close()
      })
    })

    pyshell.stderr.on('data', (err) => {
      //console.log("ERROR", String.fromCharCode.apply(null, err))
      const {PythonShell} = require('python-shell')
      const path = require("path")
      let options = {
        scriptPath : path.join(__dirname, './engine/'),
      }
      
      bootScript = new PythonShell('boot.py', options)

      bootScript.on('message', (message) => {
        //console.log("HERE", message)
        boot(JSON.parse(message))
        bootScript.terminate()
      })
    })

    window.first = false
    pyshell.stdout.on('data', (message) => {
      message = JSON.parse(message)
      boot(message)

      if (process.platform == "win32") {
        child_process.exec('taskkill /pid ' + pyshell.pid + ' /T /F')
      } else {
        child_process.kill()
      }
    })

    function boot(message) {
      //console.log(message)
      if (!message.ip) {
        window.first = true
        swal({
          title:"Setting up Vision!",
          text:message,
          icon:"./assets/loading.gif",
          buttons:false
        })
      } else {
        if (window.first) {
          swal({
            title:"You are good to go!",
            text:" ",
            icon:"success",
            buttons:false,
            timer:2000
          })
        }
        document.getElementById("ip").innerHTML = message.ip
        document.getElementById("gateway").innerHTML = message.gateway
      }
    }
  </script>
</html>